<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8>
  <title>My first Three.js app</title>
  <style>
  body { margin: 0; }
  #texture {
    position:absolute;
    bottom:0;
    left:0;
    margin:0;
    padding:0;
    width:400px;
    height:400px;
    z-index: 2;
    background-color:white;
    transition-property: bottom, left;
    transition-duration: 0.2s;
    transition-timing-function: ease-in-out;
  }
  #texture.hide {
    bottom:-380px;
    left:-380px;
  }
  #webgl-canvas {
    margin:0;
    padding:0;
    width:100%;
    height:100%;
  }
  #textures {
    margin:0;
    padding:0;
    position:absolute;
    top:0;
    right:0;
    width:30px;
  }
  #textures img {
    margin:0;
    padding:0;
    float:left;
    width:30px;
    height:30px;
  }
  #geometries {
    margin:0;
    padding:0;
    position:absolute;
    top:0;
    left:0;
    width:60px;
    text-align:right;
  }
  #geometries button {
    width:65px;
    height:30px;
    background-color:white;
    border:1px solid gray;
    margin:0;
  }
  </style>
</head>
<body>
<div id="textures">
  <img src="white.png">
  <img src="r2b.jpg">
  <img src="b2r.jpg">
  <img src="texture.png">
  <img src="soil.png">
  <img src="iron.png">
</div>
<div id="geometries">
  <button>torus</button>
  <button>torusKnot</button>
  <button>yoda</button>
</div>
<canvas id="texture" class="hide" width="400" height="400"></canvas>
<script src="lib/three.js"></script>
<script src="lib/OrbitControls.js"></script>
<script src="lib/STLLoader.js"></script>
<script>
(function() {
  var texture = document.getElementById('texture');
  texture.addEventListener('click', function() {
    if (texture.className === 'hide') {
      texture.className = '';
    }
    else {
      texture.className = 'hide';
    }
  });
})();
</script>
<script>
function swapFaces(geometry, face) {
  return;
  var va = geometry.vertices[face.a];
  var vb = geometry.vertices[face.b];
  var vc = geometry.vertices[face.c];
  if (va.y < vb.y) {
    if (vc.y < va.y) {
      var swap = face.b;
      face.b = face.a;
      face.a = face.c;
      face.c = swap;
    }
  }
  else if (vb.y < vc.y) {
    var swap = face.a;
    face.a = face.b
    face.b = face.c
    face.c = swap;
  }
  else {
    var swap = face.b;
    face.b = face.a;
    face.a = face.c;
    face.c = swap;
  }
}

function setupGeometryUvs(targetMesh, sphereMesh) {
  var raycaster = new THREE.Raycaster(new THREE.Vector3());
  targetMesh.geometry.faces.forEach(function(face, faceIndex) {
    var origin = sphereMesh.position.clone().add(face.normal.clone().multiplyScalar(2));
    var direction = face.normal.clone().negate();
    raycaster.set(origin, direction);
    var intersects = raycaster.intersectObject(sphereMesh);
    if (0 < intersects.length) {
      swapFaces(targetMesh.geometry, face);
      var intersect = intersects[0];
      var uv = sphereMesh.geometry.faceVertexUvs[0][intersect.faceIndex];
      for (var i = 0; i < 3; i++) {
        targetMesh.geometry.faceVertexUvs[0][faceIndex][i].copy(uv[i]);
      }
    }
    else {
      console.log('intersects is []. (faceIndex = ' + faceIndex + ')');
    }
  });
}

function createTargetMesh(type, texture, after) {
  var targetGeometry;
  if (type === 'torus') {
    targetGeometry = new THREE.TorusGeometry(1, 0.3, 128, 64);
    var targetMaterial = new THREE.MeshBasicMaterial({map:new THREE.Texture(texture)});
    var targetMesh = new THREE.Mesh(targetGeometry, targetMaterial);
    setupGeometryUvs(targetMesh, sphereMesh);
    if (after) after(targetMesh);
    return targetMesh;
  }
  else if (type === 'torusKnot') {
    targetGeometry = new THREE.TorusKnotGeometry(1, 0.3, 256, 32);
    var targetMaterial = new THREE.MeshBasicMaterial({map:new THREE.Texture(texture)});
    var targetMesh = new THREE.Mesh(targetGeometry, targetMaterial);
    setupGeometryUvs(targetMesh, sphereMesh);
    if (after) after(targetMesh);
    return targetMesh;
  }
  else if (type === 'yoda') {
    var loader = new THREE.STLLoader();
    loader.addEventListener('load', function(event) {
      var tergetGeometry = event.content;
      var targetMaterial = new THREE.MeshBasicMaterial({map:new THREE.Texture(texture)});
      var targetMesh = new THREE.Mesh(targetGeometry, targetMaterial);
      setupGeometryUvs(targetMesh, sphereMesh);
      if (after) after(targetMesh);
    });
    loader.load('Yoda-SuperLite.stl');
  }
}

var texture = document.getElementById('texture');
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.z = 3;

var renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.domElement.id = 'wegbl-canvas';
document.body.appendChild(renderer.domElement);

var sphereGeometry = new THREE.SphereGeometry(1, 32, 32);
sphereGeometry.faces.forEach(function(face, faceIndex) {
  swapFaces(sphereGeometry, face);
  var uv = sphereGeometry.faceVertexUvs[0][faceIndex];
  ['a', 'b', 'c'].forEach(function(vi, i) {
    uv[i].x = sphereGeometry.vertices[face[vi]].x / 2 + 0.5;
    uv[i].y = sphereGeometry.vertices[face[vi]].y / 2 + 0.5;
  });
});
var sphereMaterial = new THREE.MeshBasicMaterial({map:new THREE.Texture(texture)});
var sphereMesh = new THREE.Mesh(sphereGeometry, sphereMaterial);
sphereMesh.material.transparent = true;
sphereMesh.material.opacity = 0;
scene.add(sphereMesh);

var targetMesh = createTargetMesh('torusKnot', texture);
scene.add(targetMesh);


var controls = new THREE.OrbitControls(camera, renderer.domElement);

function render() {
  requestAnimationFrame(render);
  controls.update();
  renderer.render(scene, camera);
}
render();






var gc = texture.getContext('2d');
var image = new Image();
image.onload = function() {
  gc.drawImage(image, 0, 0);
  sphereMesh.material.map.needsUpdate = true;
  targetMesh.material.map.needsUpdate = true;
};
image.src = 'iron.png';

var imgs = document.querySelectorAll('#textures img');
imgs.forEach(function(img) {
  img.addEventListener('click', function() {
    image.src = img.src;
  });
});

buttons = document.querySelectorAll('#geometries button');
buttons.forEach(function(button) {
  button.addEventListener('click', function() {
    var newMesh = createTargetMesh(button.textContent, texture);
    if (newMesh) {
      scene.remove(targetMesh);
      targetMesh = newMesh;
      scene.add(targetMesh);
      targetMesh.material.map.needsUpdate = true;
    }
  });
});
</script>
</body>
</html>
