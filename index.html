<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8>
  <link rel="icon" type="image/png" href="./img/favicon-32x32.png" sizes="32x32">
  <title>Handshade</title>
  <link rel="stylesheet" href="css/main.css" type="text/css"></link>
</head>
<body>
<header>
  <div><span>&#x1F52E;</span> Handshade</div>
</header>
<div id="main">
  <div id="qrcode" class="hide"></div>
  <video id="camera-view" class="hide" width="300" height="400" autoplay></video>
  <canvas id="texture" width="400" height="400"></canvas>
  <div id="dat-gui-container"></div>
  <canvas id="webgl-canvas"></canvas>
</div>
<div id="foot">
  <a href="http://dcgi.fel.cvut.cz/home/sykorad/stylit" target="_blank">Inspired by http://dcgi.fel.cvut.cz/home/sykorad/stylit</a>
</div>

<script src="https://skyway.io/dist/0.3/peer.js"></script>
<script src="lib/three.js"></script>
<script src="lib/OrbitControls.js"></script>
<script src="lib/STLLoader.js"></script>
<script src="lib/qrcode.js"></script>
<script src="lib/dat.gui.min.js"></script>
<script src="js/handshade.js"></script>
<script>
if (typeof Peer !== 'undefined') {
  var peer = new Peer({key: '743eda5e-f6f2-42f1-867e-a7d767c12bd9'});
  peer.on('open', function(id) {
    new QRCode(qrcode, {
      text: window.location + 'camera.html#' + id,
      width: 128,
      height: 128
    });
  });
  peer.on('call', function(call) {
    call.on('stream', function(stream) {
      video.src = window.URL.createObjectURL(stream);
    });
    call.answer();
  });
  var streaming = false;
  peer.on('connection', function(conn) {
    conn.on('open', function() {
      conn.on('data', function(data) {
        console.log('received: ' + data);
        if (data === 'start') {
          qrcode.className = 'hide';
          //video.className = '';
          streaming = true;
          targetMesh.material.map.needsUpdate = true;
          sphereMesh.material.map.needsUpdate = true;
        }
        else if (data === 'freeze') {
          streaming = false;
          video.click();
        }
      });
    });
  });
  function reflectVideoIfNeeded() {
    if (streaming) {
      reflectVideo();
    }
    window.requestAnimationFrame(reflectVideoIfNeeded);
  }
  reflectVideoIfNeeded();
}
</script>
</body>
</html>
